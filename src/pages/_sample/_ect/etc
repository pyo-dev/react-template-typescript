import React from 'react'
import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  getFilteredRowModel,
  flexRender,
} from '@tanstack/react-table'
import { useVirtualizer } from '@tanstack/react-virtual'

interface VirtualTableProps {
  columns: string[]
  rows: any[][]
  freezeLeft?: number   // ÏôºÏ™Ω Í≥†Ï†ï Ïª¨Îüº Í∞úÏàò
  freezeRight?: number  // Ïò§Î•∏Ï™Ω Í≥†Ï†ï Ïª¨Îüº Í∞úÏàò
}

export default function VirtualTable({
  columns,
  rows,
  freezeLeft = 1,
  freezeRight = 0,
}: VirtualTableProps) {
  const parentRef = React.useRef<HTMLDivElement>(null)
  const [sorting, setSorting] = React.useState<any[]>([])
  const [columnFilters, setColumnFilters] = React.useState<any[]>([])
  const [selectedRows, setSelectedRows] = React.useState<Set<number>>(new Set())

  const data = React.useMemo(() => {
    return rows.map(row => {
      const obj: Record<string, any> = {}
      columns.forEach((col, i) => {
        obj[col] = row[i] ?? ''
      })
      return obj
    })
  }, [columns, rows])

  const multiFilterFn = React.useCallback((row: any, columnId: string, filterValue: string) => {
    if (!filterValue) return true
    const values = filterValue
      .split(',')
      .map(v => v.trim().toLowerCase())
      .filter(Boolean)
    const cellValue = String(row.getValue(columnId) ?? '').toLowerCase()
    return values.some(v => cellValue.includes(v))
  }, [])

  const columnDefs = React.useMemo(() => {
    const defs: any[] = [
      {
        id: 'select',
        header: () => (
          <input
            type="checkbox"
            onChange={e => {
              if (e.target.checked) setSelectedRows(new Set(data.map((_, i) => i)))
              else setSelectedRows(new Set())
            }}
            checked={selectedRows.size === data.length && data.length > 0}
          />
        ),
        cell: (info: any) => (
          <input
            type="checkbox"
            checked={selectedRows.has(info.row.index)}
            onChange={e => {
              const newSet = new Set(selectedRows)
              if (e.target.checked) newSet.add(info.row.index)
              else newSet.delete(info.row.index)
              setSelectedRows(newSet)
            }}
          />
        ),
        size: 40,
      },
      ...columns.map(col => ({
        accessorKey: col,
        header: col,
        filterFn: multiFilterFn,
        cell: (info: any) => String(info.getValue() ?? ''),
      })),
    ]
    return defs
  }, [columns, data, selectedRows, multiFilterFn])

  const table = useReactTable({
    data,
    columns: columnDefs,
    state: { sorting, columnFilters },
    onSortingChange: setSorting,
    onColumnFiltersChange: setColumnFilters,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
  })

  const rowVirtualizer = useVirtualizer({
    count: table.getRowModel().rows.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 35,
    overscan: 10,
  })

  const handlePrintSelected = () => {
    const selectedData = Array.from(selectedRows).map(i => data[i])
    console.log('‚úÖ ÏÑ†ÌÉùÎêú Îç∞Ïù¥ÌÑ∞:', selectedData)
    alert(`${selectedData.length}Í±¥ ÏÑ†ÌÉùÎê® (ÏΩòÏÜî ÌôïÏù∏)`)
  }

  // üîπ Ï¢åÏö∞ Í≥†Ï†ï Í≥ÑÏÇ∞
  const leftStickyCols = freezeLeft
  const rightStickyCols = freezeRight
  const totalCols = columnDefs.length

  const getStickyStyle = (colIndex: number): React.CSSProperties => {
    if (colIndex < leftStickyCols) {
      const offset = colIndex * 120 // Í∞ÄÎ°úÌè≠ Í≥ÑÏÇ∞
      return {
        position: 'sticky',
        left: `${offset}px`,
        zIndex: 2,
        background: '#fff',
      }
    }
    if (colIndex >= totalCols - rightStickyCols) {
      const rightOffset = (totalCols - 1 - colIndex) * 120
      return {
        position: 'sticky',
        right: `${rightOffset}px`,
        zIndex: 2,
        background: '#fff',
      }
    }
    return {}
  }

  return (
    <div>
      <button
        onClick={handlePrintSelected}
        style={{
          marginBottom: '8px',
          padding: '6px 12px',
          background: '#007bff',
          color: '#fff',
          border: 'none',
          borderRadius: '4px',
          cursor: 'pointer',
        }}
      >
        ÏÑ†ÌÉù Îç∞Ïù¥ÌÑ∞ Ï∂úÎ†•
      </button>

      <div
        ref={parentRef}
        style={{
          height: '600px',
          overflow: 'auto',
          border: '1px solid #ccc',
          position: 'relative',
          fontFamily: 'sans-serif',
          whiteSpace: 'nowrap',
        }}
      >
        <div style={{ height: `${rowVirtualizer.getTotalSize()}px`, position: 'relative' }}>
          {/* Ìó§Îçî */}
          <div
            style={{
              position: 'sticky',
              top: 0,
              zIndex: 3,
              background: '#f0f0f0',
              borderBottom: '1px solid #ccc',
            }}
          >
            <div style={{ display: 'flex' }}>
              {table.getHeaderGroups().map(headerGroup =>
                headerGroup.headers.map((header, i) => (
                  <div
                    key={header.id}
                    style={{
                      minWidth: header.column.columnDef.id === 'select' ? 40 : 120,
                      padding: '6px 8px',
                      fontWeight: 'bold',
                      borderRight: '1px solid #ddd',
                      cursor: header.column.getCanSort() ? 'pointer' : 'default',
                      userSelect: 'none',
                      ...getStickyStyle(i),
                    }}
                    onClick={header.column.getToggleSortingHandler()}
                  >
                    {flexRender(header.column.columnDef.header, header.getContext())}
                    {{
                      asc: ' üîº',
                      desc: ' üîΩ',
                    }[header.column.getIsSorted() as string] ?? ''}
                  </div>
                ))
              )}
            </div>

            {/* ÌïÑÌÑ∞ ÏûÖÎ†• */}
            <div style={{ display: 'flex', borderBottom: '1px solid #ccc' }}>
              {table.getHeaderGroups()[0].headers.map((header, i) => (
                <div
                  key={header.id}
                  style={{
                    minWidth: header.column.columnDef.id === 'select' ? 40 : 120,
                    borderRight: '1px solid #eee',
                    padding: '4px 6px',
                    background: '#fafafa',
                    ...getStickyStyle(i),
                    zIndex: 2,
                  }}
                >
                  {header.column.getCanFilter() &&
                  header.column.columnDef.id !== 'select' ? (
                    <input
                      type="text"
                      value={(header.column.getFilterValue() as string) ?? ''}
                      onChange={e => header.column.setFilterValue(e.target.value)}
                      placeholder="ÏâºÌëúÎ°ú Ïó¨Îü¨Í∞í"
                      style={{
                        width: '100%',
                        border: '1px solid #ccc',
                        borderRadius: '3px',
                        padding: '2px 4px',
                        fontSize: '12px',
                      }}
                    />
                  ) : null}
                </div>
              ))}
            </div>
          </div>

          {/* Îç∞Ïù¥ÌÑ∞ Ìñâ */}
          {rowVirtualizer.getVirtualItems().map(virtualRow => {
            const row = table.getRowModel().rows[virtualRow.index]
            if (!row) return null
            return (
              <div
                key={row.id}
                style={{
                  display: 'flex',
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  width: 'fit-content',
                  transform: `translateY(${virtualRow.start}px)`,
                  borderBottom: '1px solid #eee',
                  background: selectedRows.has(row.index) ? '#e6f3ff' : 'transparent',
                }}
              >
                {row.getVisibleCells().map((cell, i) => (
                  <div
                    key={cell.id}
                    style={{
                      minWidth: cell.column.columnDef.id === 'select' ? 40 : 120,
                      padding: '8px',
                      borderRight: '1px solid #eee',
                      overflow: 'hidden',
                      textOverflow: 'ellipsis',
                      ...getStickyStyle(i),
                    }}
                  >
                    {flexRender(cell.column.columnDef.cell, cell.getContext())}
                  </div>
                ))}
              </div>
            )
          })}
        </div>
      </div>
    </div>
  )
}
