import React from 'react'
import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  getFilteredRowModel,
  flexRender,
} from '@tanstack/react-table'
import { useVirtualizer } from '@tanstack/react-virtual'

interface VirtualTableProps {
  columns: string[]
  rows: any[][]
  freezeLeft?: number
  freezeRight?: number
}

export default function VirtualTable({
  columns,
  rows,
  freezeLeft = 1,
  freezeRight = 0,
}: VirtualTableProps) {
  const HEADER_HEIGHT = 70 // í—¤ë” + í•„í„° ì˜ì—­ ë†’ì´ í•©
  const parentRef = React.useRef<HTMLDivElement>(null)
  const [sorting, setSorting] = React.useState<any[]>([])
  const [columnFilters, setColumnFilters] = React.useState<any[]>([])
  const [selectedRows, setSelectedRows] = React.useState<Set<number>>(new Set())
  const [tempFilters, setTempFilters] = React.useState<Record<string, string>>({})

  // ğŸ”¹ ë°ì´í„° ë³€í™˜ ë° ë¬¸ìì—´ ì•ˆì „ ì²˜ë¦¬
  const data = React.useMemo(() => {
    return rows.map(row => {
      const obj: Record<string, string> = {}
      columns.forEach((col, i) => {
        obj[col] = row[i] != null ? String(row[i]) : ''
      })
      return obj
    })
  }, [columns, rows])

  // ğŸ”¹ ë‹¨ì¼ ì»¬ëŸ¼ í•„í„° í•¨ìˆ˜ (ì½¤ë§ˆ í•„ìš” ì—†ìŒ, ì»¬ëŸ¼ ê°„ AND)
  const columnFilterFn = React.useCallback(
    (row: any, columnId: string, filterValue: string) => {
      if (!filterValue) return true
      const cellValue = String(row.getValue(columnId) ?? '').toLowerCase()
      return cellValue.includes(filterValue.toLowerCase())
    },
    []
  )

  // ğŸ”¹ ì»¬ëŸ¼ ì •ì˜
  const columnDefs = React.useMemo(() => {
    const defs: any[] = [
      {
        id: 'select',
        header: () => (
          <input
            type="checkbox"
            onChange={e => {
              if (e.target.checked) setSelectedRows(new Set(data.map((_, i) => i)))
              else setSelectedRows(new Set())
            }}
            checked={selectedRows.size === data.length && data.length > 0}
          />
        ),
        cell: (info: any) => (
          <input
            type="checkbox"
            checked={selectedRows.has(info.row.index)}
            onChange={e => {
              const newSet = new Set(selectedRows)
              if (e.target.checked) newSet.add(info.row.index)
              else newSet.delete(info.row.index)
              setSelectedRows(newSet)
            }}
          />
        ),
        size: 40,
      },
      ...columns.map(col => ({
        accessorKey: col,
        header: col,
        filterFn: columnFilterFn,
        cell: (info: any) => {
          const value = info.row.original[col]
          return value != null ? String(value) : ''
        },
      })),
    ]
    return defs
  }, [columns, data, selectedRows, columnFilterFn])

  // ğŸ”¹ React Table ì´ˆê¸°í™”
  const table = useReactTable({
    data,
    columns: columnDefs,
    state: { sorting, columnFilters },
    onSortingChange: setSorting,
    onColumnFiltersChange: setColumnFilters,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
  })

  // ğŸ”¹ ê°€ìƒ ìŠ¤í¬ë¡¤
  const rowVirtualizer = useVirtualizer({
    count: table.getRowModel().rows.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 35,
    overscan: 10,
  })

  // ğŸ”¹ ì¢Œìš° ê³ ì • ê³„ì‚°
  const leftStickyCols = freezeLeft
  const rightStickyCols = freezeRight
  const totalCols = columnDefs.length

  const getStickyStyle = (colIndex: number): React.CSSProperties => {
    if (colIndex < leftStickyCols) {
      const offset = colIndex * 120
      return { position: 'sticky', left: `${offset}px`, zIndex: 2, background: '#fff' }
    }
    if (colIndex >= totalCols - rightStickyCols) {
      const rightOffset = (totalCols - 1 - colIndex) * 120
      return { position: 'sticky', right: `${rightOffset}px`, zIndex: 2, background: '#fff' }
    }
    return {}
  }

  const handlePrintSelected = () => {
    const selectedData = Array.from(selectedRows).map(i => data[i])
    console.log('âœ… ì„ íƒëœ ë°ì´í„°:', selectedData)
    alert(`${selectedData.length}ê±´ ì„ íƒë¨ (ì½˜ì†” í™•ì¸)`)
  }

  return (
    <div>
      <button
        onClick={handlePrintSelected}
        style={{
          marginBottom: '8px',
          padding: '6px 12px',
          background: '#007bff',
          color: '#fff',
          border: 'none',
          borderRadius: '4px',
          cursor: 'pointer',
        }}
      >
        ì„ íƒ ë°ì´í„° ì¶œë ¥
      </button>

      <div
        ref={parentRef}
        style={{
          height: '600px',
          overflow: 'auto',
          border: '1px solid #ccc',
          position: 'relative',
          fontFamily: 'sans-serif',
          whiteSpace: 'nowrap',
        }}
      >
        <div style={{ height: `${rowVirtualizer.getTotalSize() + HEADER_HEIGHT}px`, position: 'relative' }}>
          {/* í—¤ë” */}
          <div
            style={{
              position: 'sticky',
              top: 0,
              zIndex: 3,
              background: '#f0f0f0',
              borderBottom: '1px solid #ccc',
              height: `${HEADER_HEIGHT}px`,
            }}
          >
            {/* í—¤ë” ì»¬ëŸ¼ */}
            <div style={{ display: 'flex' }}>
              {table.getHeaderGroups().map(headerGroup =>
                headerGroup.headers.map((header, i) => (
                  <div
                    key={header.id}
                    style={{
                      minWidth: header.column.columnDef.id === 'select' ? 40 : 120,
                      padding: '6px 8px',
                      fontWeight: 'bold',
                      borderRight: '1px solid #ddd',
                      cursor: header.column.getCanSort() ? 'pointer' : 'default',
                      userSelect: 'none',
                      ...getStickyStyle(i),
                    }}
                    onClick={header.column.getToggleSortingHandler()}
                  >
                    {flexRender(header.column.columnDef.header, header.getContext())}
                    {header.column.getIsSorted() === 'asc'
                      ? ' ğŸ”¼'
                      : header.column.getIsSorted() === 'desc'
                      ? ' ğŸ”½'
                      : ''}
                  </div>
                ))
              )}
            </div>

            {/* í•„í„° ì…ë ¥ + ë²„íŠ¼ */}
            <div style={{ display: 'flex', borderBottom: '1px solid #ccc' }}>
              {table.getHeaderGroups()[0].headers.map((header, i) => (
                <div
                  key={header.id}
                  style={{
                    minWidth: header.column.columnDef.id === 'select' ? 40 : 120,
                    borderRight: '1px solid #eee',
                    padding: '4px 6px',
                    background: '#fafafa',
                    ...getStickyStyle(i),
                    zIndex: 2,
                  }}
                >
                  {header.column.getCanFilter() &&
                  header.column.columnDef.id !== 'select' ? (
                    <>
                      <input
                        type="text"
                        value={tempFilters[header.column.id] ?? ''}
                        onChange={e =>
                          setTempFilters(prev => ({
                            ...prev,
                            [header.column.id]: e.target.value,
                          }))
                        }
                        placeholder="ê²€ìƒ‰"
                        style={{
                          width: '100%',
                          border: '1px solid #ccc',
                          borderRadius: '3px',
                          padding: '2px 4px',
                          fontSize: '12px',
                        }}
                      />
                      <div style={{ display: 'flex', marginTop: '2px', gap: '2px' }}>
                        <button
                          onClick={() =>
                            header.column.setFilterValue(tempFilters[header.column.id] ?? '')
                          }
                          style={{
                            padding: '2px 4px',
                            fontSize: '10px',
                            cursor: 'pointer',
                          }}
                        >
                          ê²€ìƒ‰
                        </button>
                        <button
                          onClick={() => {
                            setTempFilters(prev => ({ ...prev, [header.column.id]: '' }))
                            header.column.setFilterValue('')
                          }}
                          style={{
                            padding: '2px 4px',
                            fontSize: '10px',
                            cursor: 'pointer',
                          }}
                        >
                          ë¦¬ì…‹
                        </button>
                      </div>
                    </>
                  ) : null}
                </div>
              ))}
            </div>
          </div>

          {/* ë°ì´í„° í–‰ */}
          {rowVirtualizer.getVirtualItems().map(virtualRow => {
            const row = table.getRowModel().rows[virtualRow.index]
            if (!row) return null
            return (
              <div
                key={row.id}
                style={{
                  display: 'flex',
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  width: 'fit-content',
                  transform: `translateY(${virtualRow.start + HEADER_HEIGHT}px)`,
                  borderBottom: '1px solid #eee',
                  background: selectedRows.has(row.index) ? '#e6f3ff' : 'transparent',
                }}
              >
                {row.getVisibleCells().map((cell, i) => (
                  <div
                    key={cell.id}
                    style={{
                      minWidth: cell.column.columnDef.id === 'select' ? 40 : 120,
                      padding: '8px',
                      borderRight: '1px solid #eee',
                      overflow: 'hidden',
                      textOverflow: 'ellipsis',
                      ...getStickyStyle(i),
                    }}
                  >
                    {flexRender(cell.column.columnDef.cell, cell.getContext())}
                  </div>
                ))}
              </div>
            )
          })}
        </div>
      </div>
    </div>
  )
}
